sap.ui.define(["sap/ui/core/mvc/Controller","sap/ui/model/json/JSONModel","sap/m/ColumnListItem","sap/m/Label","sap/m/Token","sap/base/util/deepExtend","sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/m/SearchField","sap/m/MessageBox","sap/ui/core/BusyIndicator","sap/ui/model/type/String","sap/ui/core/Item","../model/models","../services/Xsjs"],function(e,t,a,o,i,n,s,r,l,d,u,c,g,h,p){"use strict";return e.extend("com.everis.centria.ZFIR098.controller.Main",{onInit:async function(){u.show(0);this.setupValueHelp();this.setupModels();this.loadData();this._sUserId=this.getLogonUser();var e=new t(sap.ui.require.toUrl("com/everis/centria/ZFIR098/model")+"/variante.json");this._oModelEntidad=e;this.getView().setModel(this._oModelEntidad,"oModelEntidad")},onPressHome:function(e){if(this.oConstantes&&this.oConstantes.rpta){let e=this.oConstantes.rpta.sDocumentUrl;let t=e.split("#");window.location.replace(t[0])}},onBeforeShow:function(e){$(document).ready(function(){$('[id*="shell-header"]').hide()})},getI18nText:function(e){return this.getView().getModel("i18n").getProperty(e)},getLogonUser:function(){var e="DEFAULT_USER";if(sap.ushell){var t=sap.ushell.Container.getService("UserInfo");if(t){e=t.getId()}}return e},setupModels:function(){this._oOperacionesModel=new t(sap.ui.require.toUrl("com/everis/centria/ZFIR098/model")+"/operaciones.json");this._oSociedadColumnsModel=new t(sap.ui.require.toUrl("com/everis/centria/ZFIR098/model")+"/sociedadColumnsModel.json");this._oBancoColumnsModel=new t(sap.ui.require.toUrl("com/everis/centria/ZFIR098/model")+"/bancoColumnsModel.json");this._oViasPagoColumnsModel=new t(sap.ui.require.toUrl("com/everis/centria/ZFIR098/model")+"/viasPagoColumnsModel.json")},setupValueHelp:function(){this._oSociedadInput=this.getView().byId("iSociedad");this._oSociedadInput.addValidator(function(e){if(e.suggestionObject){var t=e.suggestionObject.getCells()[0].getText();var a=e.suggestionObject.getCells()[1].getText()+" ("+t+")";return new i({key:t,text:a})}return null});this._oBancoInput=this.getView().byId("iBanco");this._oBancoInput.addValidator(function(e){if(e.suggestionObject){var t=e.suggestionObject.getCells()[1].getText();var a=e.suggestionObject.getCells()[4].getText()+" ("+t+")";return new i({key:t,text:a})}return null});this._oViasPagoInput=this.getView().byId("iViasPago");this._oViasPagoInput.addValidator(function(e){if(e.suggestionObject){var t=e.suggestionObject.getCells()[0].getText();var a=e.suggestionObject.getCells()[2].getText()+" ("+t+")";return new i({key:t,text:a})}return null})},loadData:function(){var e={};var a=new t(e);a.setSizeLimit(1e3);this._oModel=a;this.getView().setModel(this._oModel);this._ODataModel=this.getView().getModel("ODataModel");var o=this;Promise.all([this.loadSociedades(),this.loadBancos(),this.loadViasDePago()]).then(function(e){o.loadOperaciones();u.hide()})},loadOperaciones:function(){this._oModel.setProperty("/Operaciones",this._oOperacionesModel.getData().list)},loadSociedades:function(){var e=this;return new Promise(function(t,a){var o="/Im_SociedadSet";e._ODataModel.read(o,{success:function(a){var o=a.results;e._oModel.setProperty("/Sociedades",o);t()},error:function(t){var o=t.message;u.hide();d.error(e.getI18nText("txtErrorOData")+o,{details:t.responseText});a()}})})},loadBancos:function(){var e=this;return new Promise(function(t,a){var o="/Im_BancosSet";e._ODataModel.read(o,{success:function(a){var o=a.results;e._oModel.setProperty("/Bancos",o);t()},error:function(t){var o=t.message;u.hide();d.error(e.getI18nText("txtErrorOData")+o,{details:t.responseText});a()}})})},loadViasDePago:function(){var e=this;return new Promise(function(t,a){var o="/Im_ViaPagoSet";e._ODataModel.read(o,{success:function(a){var o=a.results;var i=1;o.forEach(function(e){e.key=i;i++});e._oModel.setProperty("/ViasPago",o);t()},error:function(t){var o=t.message;u.hide();d.error(e.getI18nText("txtErrorOData")+o,{details:t.responseText});a()}})})},onSociedadValueHelpRequest:function(){u.show(0);var e=this._oSociedadColumnsModel.getData().cols;this._oBasicSearchField=new l({showSearchButton:false});this._oValueHelpDialog=sap.ui.xmlfragment("com.everis.centria.ZFIR098.view.dialogs.SociedadValueHelpDialog",this);this.getView().addDependent(this._oValueHelpDialog);this._oValueHelpDialog.setRangeKeyFields([{label:"Sociedad",key:"Zbukr",type:"string",typeInstance:new c({},{maxLength:7})}]);var t=this._oValueHelpDialog.getFilterBar();t.setFilterBarExpanded(false);t.setBasicSearch(this._oBasicSearchField);this._oValueHelpDialog.getTableAsync().then(function(t){t.setModel(this._oModel);t.setModel(this._oSociedadColumnsModel,"columns");if(t.bindRows){t.bindAggregation("rows","/Sociedades")}if(t.bindItems){t.bindAggregation("items","/Sociedades",function(){return new a({cells:e.map(function(e){return new o({text:"{"+e.template+"}"})})})})}this._oValueHelpDialog.update();u.hide()}.bind(this));this._oValueHelpDialog.setTokens(this._oSociedadInput.getTokens());this._oValueHelpDialog.open()},onBancoValueHelpRequest:function(){u.show(0);var e=this._oBancoColumnsModel.getData().cols;this._oBasicSearchField=new l({showSearchButton:false});this._oValueHelpDialog=sap.ui.xmlfragment("com.everis.centria.ZFIR098.view.dialogs.BancoValueHelpDialog",this);this.getView().addDependent(this._oValueHelpDialog);this._oValueHelpDialog.setRangeKeyFields([{label:"Banco",key:"Hbkid",type:"string",typeInstance:new c({},{maxLength:7})}]);var t=this._oValueHelpDialog.getFilterBar();t.setFilterBarExpanded(false);t.setBasicSearch(this._oBasicSearchField);this._oValueHelpDialog.getTableAsync().then(function(t){t.setModel(this._oModel);t.setModel(this._oBancoColumnsModel,"columns");if(t.bindRows){t.bindAggregation("rows","/Bancos")}if(t.bindItems){t.bindAggregation("items","/Bancos",function(){return new a({cells:e.map(function(e){return new o({text:"{"+e.template+"}"})})})})}this._oValueHelpDialog.update();u.hide()}.bind(this));this._oValueHelpDialog.setTokens(this._oBancoInput.getTokens());this._oValueHelpDialog.open()},onViasPagoValueHelpRequest:function(){u.show(0);var e=this._oViasPagoColumnsModel.getData().cols;this._oBasicSearchField=new l({showSearchButton:false});this._oValueHelpDialog=sap.ui.xmlfragment("com.everis.centria.ZFIR098.view.dialogs.ViasPagoValueHelpDialog",this);this.getView().addDependent(this._oValueHelpDialog);this._oValueHelpDialog.setRangeKeyFields([{label:"Vías de Pago",key:"Rzawe",type:"string",typeInstance:new c({},{maxLength:7})}]);var t=this._oValueHelpDialog.getFilterBar();t.setFilterBarExpanded(false);t.setBasicSearch(this._oBasicSearchField);this._oValueHelpDialog.getTableAsync().then(function(t){t.setModel(this._oModel);t.setModel(this._oViasPagoColumnsModel,"columns");if(t.bindRows){t.bindAggregation("rows","/ViasPago")}if(t.bindItems){t.bindAggregation("items","/ViasPago",function(){return new a({cells:e.map(function(e){return new o({text:"{"+e.template+"}"})})})})}this._oValueHelpDialog.update();u.hide()}.bind(this));this._oValueHelpDialog.setTokens(this._oViasPagoInput.getTokens());this._oValueHelpDialog.open()},onSociedadesFilterBarSearch:function(e){var t=this._oBasicSearchField.getValue(),a=e.getParameter("selectionSet");var o=a.reduce(function(e,t){if(t.getValue()){e.push(new s({path:t.getName(),operator:r.Contains,value1:t.getValue()}))}return e},[]);o.push(new s({filters:[new s({path:"Bukrs",operator:r.Contains,value1:t}),new s({path:"Butxt",operator:r.Contains,value1:t})],and:false}));this._filterTable(new s({filters:o,and:true}))},onBancosFilterBarSearch:function(e){var t=this._oBasicSearchField.getValue(),a=e.getParameter("selectionSet");var o=a.reduce(function(e,t){if(t.getValue()){e.push(new s({path:t.getName(),operator:r.Contains,value1:t.getValue()}))}return e},[]);o.push(new s({filters:[new s({path:"Hbkid",operator:r.Contains,value1:t}),new s({path:"Banka",operator:r.Contains,value1:t})],and:false}));this._filterTable(new s({filters:o,and:true}))},onViasPagoFilterBarSearch:function(e){var t=this._oBasicSearchField.getValue(),a=e.getParameter("selectionSet");var o=a.reduce(function(e,t){if(t.getValue()){e.push(new s({path:t.getName(),operator:r.Contains,value1:t.getValue()}))}return e},[]);o.push(new s({filters:[new s({path:"Zlsch",operator:r.Contains,value1:t}),new s({path:"Text1",operator:r.Contains,value1:t})],and:false}));this._filterTable(new s({filters:o,and:true}))},_filterTable:function(e){var t=this._oValueHelpDialog;t.getTableAsync().then(function(a){if(a.bindRows){a.getBinding("rows").filter(e)}if(a.bindItems){a.getBinding("items").filter(e)}t.update()})},onSociedadValueHelpOkPress:function(e){var t=e.getParameter("tokens");this._oSociedadInput.setTokens(t);this._oValueHelpDialog.close()},onBancoValueHelpOkPress:function(e){var t=e.getParameter("tokens");this._oBancoInput.setTokens(t);this._oValueHelpDialog.close()},onViasPagoValueHelpOkPress:function(e){var t=e.getParameter("tokens");this._oViasPagoInput.setTokens(t);this._oValueHelpDialog.close()},onValueHelpCancelPress:function(){this._oValueHelpDialog.close()},onValueHelpAfterClose:function(){this._oValueHelpDialog.destroy()},onCloseFragment:function(e){this._oFragment.close()},onAfterCloseFragment:function(e){this._oFragment.destroy()},onCloseFragmentEntidad:function(e){this._oFragmentEntidad.close()},onAfterCloseFragmentEntidad:function(e){this._oFragmentEntidad.destroy()},createFilter:function(e){return new s({path:e.keyField,operator:e.exclude?"NE":e.operation,value1:e.value1,value2:e.value2})},onEjecutar:function(e){var a=this.getView().byId("iSociedad");if(a.getTokens().length===0){d.error(this.getI18nText("txtErrorSociedad"));return}var o=this.getView().byId("drsDiaEjecucion");if(o.getDateValue()===""){d.error(this.getI18nText("txtErrorDiaEjecucion"));return}var i=this.getView().byId("iIdentificacionFrom");if(i.getValue()===""){d.error(this.getI18nText("txtErrorIdentificador"));return}var n=this;var l=[];var c=this.getView().byId("sEntidad").getSelectedKey();l.push(new s({path:"Banco",operator:r.EQ,value1:c}));var g=a.getTokens();g.forEach(function(e){if(e.data().range){var t=e.data().range;var a=n.createFilter(t);l.push(a)}else{l.push(new s({path:"Zbukr",operator:r.EQ,value1:e.getKey()}))}});l.push(new s({path:"Laufd",operator:r.BT,value1:o.getFrom(),value2:o.getTo()}));var h=this.getView().byId("iIdentificacionTo");if(h.getValue()===""){l.push(new s({path:"Laufi",operator:r.EQ,value1:i.getValue()}))}else{l.push(new s({path:"Laufi",operator:r.BT,value1:i.getValue(),value2:h.getValue()}))}var p=this.getView().byId("iBanco");var f=p.getTokens();f.forEach(function(e){if(e.data().range){var t=e.data().range;var a=n.createFilter(t);l.push(a)}else{l.push(new s({path:"Hbkid",operator:r.EQ,value1:e.getKey()}))}});var m=this.getView().byId("iViasPago");var v=m.getTokens();v.forEach(function(e){if(e.data().range){var t=e.data().range;var a=n.createFilter(t);l.push(a)}else{var o=e.getText();var i=o[0];l.push(new s({path:"Rzawe",operator:r.EQ,value1:i}))}});var V=this.getView().byId("dFechaProcesar").getValue();if(V!==""){l.push(new s({path:"Zaldt",operator:r.EQ,value1:V}))}var I=this.getView().byId("swDescargaDirecta");u.show(0);var _="/Im_Text_H2hSet";this._ODataModel.read(_,{filters:l,success:function(e){if(e.results.length>0){n._sFileData=e.results[0].FileData;n._sFileName=e.results[0].FileName;if(I.getState()){n.onDownload()}else{var a={};a.Respuesta=e.results;a.sumaImporte=n.sumImporte(e.results);var o=new t(a);n.getView().setModel(o,"oModelRespuesta");if(c==="BBVA"){n._oFragment=sap.ui.xmlfragment("com.everis.centria.ZFIR098.view.fragments.RespuestaExtra",n)}else{n._oFragment=sap.ui.xmlfragment("com.everis.centria.ZFIR098.view.fragments.Respuesta",n)}n.getView().addDependent(n._oFragment);n._oFragment.open()}}else{d.information(n.getI18nText("txtInfoNoData"))}u.hide()},error:function(e){var t=e.message;u.hide();d.error(n.getI18nText("txtErrorOData")+t,{details:e.responseText})}})},clearAllFilters:function(e){var t=sap.ui.getCore().byId("tRespuesta");var a=t.getColumns();for(var o=0;o<a.length;o++){t.filter(a[o],null)}},sumImporte:function(e){var t=0;e.forEach(function(e){t+=parseFloat(e.Dmbtr)});return t.toFixed(2)},onDownload:function(e){var t=this._sFileData;var a=this._sFileName;var o=document.createElement("a");document.body.appendChild(o);o.style="display: none";o.href="data:text/plain;base64,"+t;o.download=a;o.click()},loadVariants:async function(){var e=this;var a="/Im_Gest_VarianteSet";var o=[];o.push(new s({path:"Tcode",operator:r.EQ,value1:"ZFIR098"}));function i(){u.show(0);return new Promise(function(i,n){e._ODataModel.read(a,{filters:o,urlParameters:{$expand:"Gest_VarianteSet"},success:function(a){var o={};o.rows=a.results;var n=new t(o);e._oVariantsModel=n;e.getView().setModel(e._oVariantsModel,"oVariantsModel");u.hide();i(true)},error:function(t){var a=t.message;u.hide();d.error(e.getI18nText("txtErrorOData")+a,{details:t.responseText});u.hide();i(false)}})})}let n=await i();if(!n){return false}var l=new t(sap.ui.require.toUrl("com/everis/centria/ZFIR098/model")+"/variante.json");this._oModelEntidad=l;this.getView().setModel(this._oModelEntidad,"oModelEntidad")},onDisplayVariants:function(e){this.loadVariants();this._oFragment=sap.ui.xmlfragment("com.everis.centria.ZFIR098.view.fragments.Variantes",this);this.getView().addDependent(this._oFragment);this._oFragment.open()},onApplyVariant:function(e){var t=sap.ui.getCore().byId("tVariants");if(t.getSelectedIndices().length===0||t.getSelectedIndices().length>1){d.information(this.getI18nText("txtInformationApply"))}else{var a=t.getSelectedIndex();var o=t.getContextByIndex(a).getObject();this.loadTemplate(o.Gest_VarianteSet.results);this._oFragment.close()}},loadTemplate:function(e){var t=this;e.forEach(function(e){switch(e.ModeAsig){case"key":t.getView().byId(e.IdControl).setSelectedKey(e.Value);break;case"value":t.getView().byId(e.IdControl).setValue(e.Value);break;case"token":t.getView().byId(e.IdControl).setTokens(t.createTokens(e.Value));break;case"selection":var a=e.Value==="true"?true:false;t.getView().byId(e.IdControl).setSelected(a);break}})},createTokens:function(e){var t=[];if(e!==""){var a=e.split(",");a.forEach(function(e){var a=e.split("|");var o=a[0].split(":");var n=new i({key:o[0],text:o[1]});if(a[1]){var s=a[1].split(":");var r={};r.exclude=s[0]==="true"?true:false;r.keyField=s[1];r.operation=s[2];r.value1=s[3];r.value2=s[4]==="null"?null:s[4];n.data("range",r)}t.push(n)})}return t},createTemplate:function(){var e=[{IdControl:"sEntidad",ModeAsig:"key",Value:""},{IdControl:"iSociedad",ModeAsig:"token",Value:""},{IdControl:"drsDiaEjecucion",ModeAsig:"value",Value:""},{IdControl:"iIdentificacionFrom",ModeAsig:"value",Value:""},{IdControl:"iIdentificacionTo",ModeAsig:"value",Value:""},{IdControl:"iBanco",ModeAsig:"token",Value:""},{IdControl:"iViasPago",ModeAsig:"token",Value:""},{IdControl:"dFechaProcesar",ModeAsig:"value",Value:""}];return e},onNewVariant:function(e){var t={};t.Tcode="ZFIR098";t.IndOperacion="C";t.Usuario=this._sUserId;t.Gest_VarianteSet=this.createTemplate();this.getView().getModel("oModelEntidad").setProperty("/Variante",t);this._oFragmentEntidad=sap.ui.xmlfragment("com.everis.centria.ZFIR098.view.fragments.FormularioVariante",this);this.getView().addDependent(this._oFragmentEntidad);this._oFragmentEntidad.bindElement({path:"/Variante",model:"oModelEntidad"});this._oFragmentEntidad.open()},onEditVariant:function(e){var t=sap.ui.getCore().byId("tVariants");if(t.getSelectedIndices().length===0||t.getSelectedIndices().length>1){d.information(this.getI18nText("txtInformationEdit"))}else{var a=t.getSelectedIndex();var o=t.getContextByIndex(a).getObject();o.IndOperacion="U";this.getView().getModel("oModelEntidad").setProperty("/Variante",o);this._oFragmentEntidad=sap.ui.xmlfragment("com.everis.centria.ZFIR098.view.fragments.FormularioVariante",this);this.getView().addDependent(this._oFragmentEntidad);this._oFragmentEntidad.bindElement({path:"/Variante",model:"oModelEntidad"});this._oFragmentEntidad.open()}},validateInputs:function(e){return e.Nombre!==""&&e.Nombre!==undefined&&(e.Descripcion!==""&&e.Descripcion!==undefined)},onSaveVariant:function(e){var t=sap.ui.getCore().byId("tVariants");var a=sap.ui.getCore().byId("fVariante");var o=a.getModel("oModelEntidad").getProperty("/Variante");if(this.validateInputs(o)){u.show(0);var i=this;var n="/Im_Gest_VarianteSet";if(o.IndOperacion==="C"){this.modifyTemplate(o.Gest_VarianteSet);this._ODataModel.create(n,o,{success:function(e){u.hide();i._oFragmentEntidad.close();d.success(i.getI18nText("txtSuccess"));t.setSelectedIndex(-1);i.loadVariants()},error:function(e){var t=e.message;u.hide();i._oFragmentEntidad.close();d.error(i.getI18nText("txtErrorOData")+t,{details:e.responseText});i.loadVariants()}})}else if(o.IndOperacion==="U"){this.modifyTemplate(o.Gest_VarianteSet.results);var s=o.Gest_VarianteSet.results;o.Gest_VarianteSet=s;this._ODataModel.create(n,o,{success:function(e){u.hide();i._oFragmentEntidad.close();d.success(i.getI18nText("txtSuccess"));t.setSelectedIndex(-1);i.loadVariants()},error:function(e){var t=e.message;u.hide();i._oFragmentEntidad.close();d.error(i.getI18nText("txtErrorOData")+t,{details:e.responseText});i.loadVariants()}})}}else{d.information(this.getI18nText("txtInformationRequired"))}},modifyTemplate:function(e){var t=this;e.forEach(function(e){switch(e.ModeAsig){case"key":e.Value=t.getView().byId(e.IdControl).getSelectedKey();break;case"value":e.Value=t.getView().byId(e.IdControl).getValue();break;case"token":e.Value=t.stringifyTokens(t.getView().byId(e.IdControl).getTokens());break;case"selection":var a=t.getView().byId(e.IdControl).getSelected();e.Value=a?"true":"false";break}})},stringifyTokens:function(e){var t="";e.forEach(function(e){if(e.data().range){var a=e.data().range;t+=e.getKey()+":"+e.getText()+"|"+a.exclude+":"+a.keyField+":"+a.operation+":"+a.value1+":"+a.value2+","}else{t+=e.getKey()+":"+e.getText()+","}});return t.substring(0,t.lastIndexOf(","))},onDeleteVariant:function(e){var t=sap.ui.getCore().byId("tVariants");if(t.getSelectedIndices().length===0||t.getSelectedIndices().length>1){d.information(this.getI18nText("txtInformationDelete"))}else{var a=this;d.confirm(this.getI18nText("txtDeleteConfirmation"),{onClose:function(e){if(e==="OK"){u.show(0);var o=t.getSelectedIndex();var i=t.getContextByIndex(o).getObject();i.IndOperacion="D";var n=i.Gest_VarianteSet.results;i.Gest_VarianteSet=n;var s="/Im_Gest_VarianteSet";a._ODataModel.create(s,i,{success:function(e){u.hide();d.success(a.getI18nText("txtSuccess"));t.setSelectedIndex(-1);a.loadVariants()},error:function(e){var t=e.message;u.hide();d.error(a.getI18nText("txtErrorOData")+t,{details:e.responseText});a.loadVariants()}})}}})}},getDocumentUrl:function(e,t,a,o){if(!e||!t||!a||!o){return""}if(this.oConstantes&&this.oConstantes.rpta){let i=this.oConstantes.rpta.sDocumentUrl;let n="?AccountingDocument="+e+"&ClearingAccountingDocument="+e+"&CompanyCode="+o+"&FiscalYear="+t.getFullYear()+"&Supplier="+a;return i+n}else{return""}},onSortTable:function(e){let t=e.getSource();let a=t.getId();let o=t.getColumns();let i=e.getParameter("column");let n=e.getParameter("sortOrder");let s=i.getSortProperty();let r,l,d;l=i.getParent().getModel("oModelRespuesta");d=l.getData();r=d.Respuesta;e.preventDefault();let u=1;if(n!=="Ascending"){u=-1}function c(e,t){if(parseFloat(e[s])<parseFloat(t[s])){return-1*u}if(parseFloat(e[s])>parseFloat(t[s])){return 1*u}return 0}function g(e,t){if(e[s]<t[s]){return-1*u}if(e[s]>t[s]){return 1*u}return 0}if(s==="Dmbtr"){r.sort(c)}else{r.sort(g)}l.refresh(true);for(let e=0;e<o.length;e++){let t=o[e];let a=t.getSortProperty();if(a===s){t.setSorted(true);t.setSortOrder(n)}else{t.setSorted(false)}}}})});