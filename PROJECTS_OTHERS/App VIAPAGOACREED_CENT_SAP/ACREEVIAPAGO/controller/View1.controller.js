sap.ui.define(["sap/ui/core/mvc/Controller","sap/m/MessageBox","sap/m/Dialog","sap/m/List","sap/m/StandardListItem","sap/m/Button","sap/m/ButtonType","../model/Formatter","sap/ui/core/Fragment","sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/ui/model/json/JSONModel","sap/ui/core/BusyIndicator","sap/m/MessageToast","sap/ui/export/Spreadsheet","sap/ui/model/Sorter","sap/m/GroupHeaderListItem","../model/models","../services/Xsjs"],function(e,t,r,a,o,l,s,n,i,d,c,u,g,f,p,h,m,b,B){"use strict";let S;let y,D;return e.extend("com.centria.ReclasificacionViasPagoAcreedores.controller.View1",{formatter:n,onInit:async function(){let e={dataDetalleBancos:[],dataDetalleFacturas:[],dataDetalleProveedores:[]};y=new u(e);this.getOwnerComponent().setModel(y,"TablaResultadosModel");let t={MontoBancoUSD:0,MontoBancoPEN:0,sPEN:"PEN",sUSD:"USD"};D=new u(t);this.getView().setModel(D,"ModeloTotales")},onPressHome:function(e){if(this.oConstantes&&this.oConstantes.rpta){let e=this.oConstantes.rpta.sDocumentUrl;let t=e.split("#");window.location.replace(t[0])}},onBeforeShow:function(e){$(document).ready(function(){$('[id*="shell-header"]').hide()})},onClearSmart:function(e){let t=this._byId("cboViaPago");t.setSelectedKeys([])},onSearchSmart:function(e){let t=this;let r=e.getSource();let a=this._byId("smtReporte");let o=r.getFilters();let l=this.byId("cboViaPago");let s=l.getSelectedKeys();let n=[];if(o.length){let e=o[0].aFilters;for(let e=0;e<s.length;e++){n.push(new d("Zlsch",c.EQ,s[e]))}let t=new d({filters:n,and:false});e.push(t)}let i=this.getServiceModel();g.show(0);i.read("/Im_TR072_Detalle_Set",{filters:o,success:function(e){let r=e.results;let a=[];let o=[];let l=[];let s={};for(let e=0;e<r.length;e++){let t=r[e];t.Dmbtr=parseFloat(t.Dmbtr);t.Wrbtr=parseFloat(t.Wrbtr);if(t.Check==="P"){o.push(t);continue}l.push(t);let a=t.Bukrs+t.Hbkid+t.Waers+t.Zlsch+t.Sgtxt;if(!s.hasOwnProperty(a)){s[a]={Bukrs:t.Bukrs,Hbkid:t.Hbkid,Waers:t.Waers,Zlsch:t.Zlsch,Sgtxt:t.Sgtxt,Nrreg:parseInt(t.Nrreg,0),Dmbtr:parseFloat(t.Dmbtr),Wrbtr:parseFloat(t.Wrbtr),Total:false}}else{s[a].Dmbtr+=parseFloat(t.Dmbtr);s[a].Wrbtr+=parseFloat(t.Wrbtr);s[a].Nrreg+=parseInt(t.Nrreg,0)}}let n=0,i=0;for(let e in s){if(s.hasOwnProperty(e)){n+=s[e].Dmbtr;i+=s[e].Wrbtr;s[e].Dmbtr=t.redondearMonto(s[e].Dmbtr);s[e].Wrbtr=t.redondearMonto(s[e].Wrbtr);a.push(s[e])}}y.setSizeLimit(l.length);D.setProperty("/MontoBancoPEN",n);D.setProperty("/MontoBancoUSD",i);let d={dataDetalleBancos:a,dataDetalleFacturas:l,dataDetalleProveedores:o};t.ordenarBanco(d.dataDetalleBancos);y.setData(d);y.refresh();g.hide()},error:function(e){g.hide();console.log(e)}})},ordenarBanco:function(e){let t=0,r=0,a=0;let o=e.length;e.sort((e,t)=>e.Bukrs.localeCompare(t.Bukrs)||e.Hbkid.localeCompare(t.Hbkid)||e.Waers.localeCompare(t.Waers));if(e.length>1){for(let l=0;l<e.length;l++){let s=e[l];if(s.Total===true){continue}if(l>0){let n=e[l-1];if(s.Bukrs!==n.Bukrs||s.Hbkid!==n.Hbkid||s.Waers!==n.Waers&&!n.Total){let i={Bukrs:n.Bukrs,Hbkid:n.Hbkid,Waers:n.Waers,Zlsch:"",Sgtxt:"",Nrreg:parseInt(a,0),Dmbtr:this.redondearMonto(parseFloat(t)),Wrbtr:this.redondearMonto(parseFloat(r)),Total:true};e.push(i);t=parseFloat(s.Dmbtr);r=parseFloat(s.Wrbtr);a=parseInt(s.Nrreg,0);if(l===o-1){let o=e[l+1];if(s.Bukrs!==o.Bukrs||s.Hbkid!==o.Hbkid||s.Waers!==o.Waers&&!o.Total){let o={Bukrs:s.Bukrs,Hbkid:s.Hbkid,Waers:s.Waers,Zlsch:"",Sgtxt:"",Nrreg:parseInt(a,0),Dmbtr:this.redondearMonto(parseFloat(t)),Wrbtr:this.redondearMonto(parseFloat(r)),Total:true};e.push(o)}}}else{t+=parseFloat(s.Dmbtr);r+=parseFloat(s.Wrbtr);a+=parseInt(s.Nrreg,0)}}else{t+=parseFloat(s.Dmbtr);r+=parseFloat(s.Wrbtr);a+=parseInt(s.Nrreg,0)}}}e.sort((e,t)=>e.Bukrs.localeCompare(t.Bukrs)||e.Hbkid.localeCompare(t.Hbkid)||e.Waers.localeCompare(t.Waers))},onInitialise:function(e){var t=e.getSource().getTable();t.bindAggregation("items",{path:"TablaResultadosModel>/dataDetalleBancos",template:this._byId("templateBancos")})},onInitialiseProveedor:function(e){var t=e.getSource().getTable();t.bindAggregation("items",{path:"TablaResultadosModel>/dataDetalleProveedores",template:this._byId("templateProveedor")})},onInitialiseFacturas:function(e){let t=this;var r=e.getSource().getTable();let a=this.byId("tableReporte");let o=a.getSelectedItems();let l=[];for(let e=0;e<o.length;e++){let t=o[e].getBindingContext("TablaResultadosModel");let r=t.getProperty("Total");if(r){continue}let a=[new d("Bukrs","EQ",t.getProperty("Bukrs")),new d("Hbkid","EQ",t.getProperty("Hbkid")),new d("Zlsch","EQ",t.getProperty("Zlsch")),new d("Waers","EQ",t.getProperty("Waers"))];let s=new d({filters:a,and:true});l.push(s)}S=new d({filters:l,and:false});function s(e){let r=t.getSubTotalesFacturas("Lifnr",e.key);return new m({title:"Acreedor: "+e.key+" | Subtotal PEN: "+r.fMontoPen+" | Subtotal USD: "+r.fMontoUsd,upperCase:false})}r.bindAggregation("items",{path:"TablaResultadosModel>/dataDetalleFacturas",filters:[S],sorter:new h("Lifnr",false,true),groupHeaderFactory:s,template:this._byId("templateFactura")})},getSubTotalesFacturas:function(e,t){let r=this.getOwnerComponent().getModel("TablaResultadosModel");if(!r){return false}let a=r.getProperty("/dataDetalleFacturas");let o=a.filter(e=>e.Lifnr===t&&e.Zlsch!="X");let l=0,s=0;for(let e=0;e<o.length;e++){l+=parseFloat(o[e].Dmbtr);s+=parseFloat(o[e].Wrbtr)}return{fMontoPen:this.redondearMonto(l),fMontoUsd:this.redondearMonto(s)}},onUpdateFinished:function(e){let t=e.getSource();let r=t.getItems();let a=this._byId("smtReporte");let o;let l=t._selectAllCheckBox;let s=0;if(l){l.setVisible(false)}function n(e,t){for(let r=0;r<e.length;r++){let a=e[r];if(t){a.setDesign(sap.m.LabelDesign.Bold)}else{a.setDesign(sap.m.LabelDesign.Standard)}}}for(let e=0;e<r.length;e++){let t=r[e].getBindingContext("TablaResultadosModel");let a=r[e].getCells();let l=t.getProperty("Total");if(!l){s++}n(a,l);o=new sap.ui.core.CustomData({key:"resaltar",value:l.toString(),writeToDom:true});let i=r[e]._oMultiSelectControl;if(i){i.setVisible(!l)}r[e].addCustomData(o)}let i=this.getI18nText("titleTableDetBan",[s]);a.setHeader(i)},onUpdateFinishFactura:function(e){let t=e.getSource();let r=t.getItems();let a=this._byId("smtFactura");let o=0,l=0;for(let e=0;e<r.length;e++){let t=r[e].getBindingContext("TablaResultadosModel");if(t){o+=parseFloat(t.getProperty("Dmbtr"));l+=parseFloat(t.getProperty("Wrbtr"))}else if(r[e].TagName==="tr"){let t=r[e].getTitle();let a=t.split(":");if(a.length===2){let o=a[0].trim();let l=a[1].trim();if(o==="Acreedor"){let a=this.getSubTotalesFacturas("Lifnr",l);t+=" | Subtotal PEN: "+a.fMontoPen+" | Subtotal USD: "+a.fMontoUsd;r[e].setTitle(t)}}}}D.setProperty("/MontoFacturaPEN",o);D.setProperty("/MontoFacturaUSD",l);let s=this.getI18nText("titleFacturas",[r.length]);a.setHeader(s);t.setBusy(false)},onUpdateFinishProveedor:function(e){let t=e.getSource();let r=t.getItems();let a=this._byId("smtProveedor");let o=0,l=0;for(let e=0;e<r.length;e++){let t=r[e].getBindingContext("TablaResultadosModel");o+=parseFloat(t.getProperty("Dmbtr"));l+=parseFloat(t.getProperty("Wrbtr"))}D.setProperty("/MontoProveedorPEN",o);D.setProperty("/MontoProveedorUSD",l);let s=this.getI18nText("titleProveedores",[r.length]);a.setHeader(s);t.setBusy(false)},onSelectionChange:function(e){let t=e.getSource();let r=e.getParameter("listItems");let a=e.getParameter("selectAll");if(a){for(let e=0;e<r.length;e++){let a=r[e].getBindingContext("TablaResultadosModel");let o=a.getProperty("Total");if(o){t.setSelectedItem(r[e],false)}}}},onBeforeRebindFactura:function(e){let t=e.getParameter("bindingParams");if(t.filters){t.filters.push(S)}else{t.filters=[];t.filters.push({aFilters:[S]})}},redondearMonto:function(e){let t=Math.round(e*100)/100;return t.toFixed(2)},onExportarExcel:function(e){let r=e.getSource().getParent().getParent();let a=r.getTable();let o=a.getColumns();let l=a.getItems();let s=[];let n=[];if(!l.length){t.information("No hay data para exportar");return false}for(let e=0;e<o.length;e++){let t=o[e].data("p13nData");let r=t.type;if(!r){r="string"}s.push({label:o[e].getHeader().getText(),property:t.columnKey,type:t.type})}for(let e=0;e<l.length;e++){let t=l[e].getBindingContext("TablaResultadosModel");let r=t.getObject();n.push(r)}let i={workbook:{columns:s},dataSource:n,fileName:r.getHeader()+".xlsx",worker:false};let d=new p(i);d.build().finally(function(){d.destroy()})},onExportarExcelTest:function(e){let r=e.getSource().getParent().getParent();let a=r.getTable();let o=a.getColumns();let l=y.getProperty("/dataDetalleFacturas");let s=[];if(!l.length){t.information("No hay data para exportar");return false}for(let e=0;e<o.length;e++){let t=o[e].data("p13nData");let r=t.type;if(!r){r="string"}s.push({label:o[e].getHeader().getText(),property:t.columnKey,type:t.type})}let n={workbook:{columns:s},dataSource:l,fileName:r.getHeader()+".xlsx",worker:false};let i=new p(n);i.build().finally(function(){i.destroy()})},_fnBeforeVariantSave:function(e){let t=e.getSource();let r=this._byId("cboViaPago");t.setFilterData({_CUSTOM:{ViaPago:r.getSelectedKeys()}})},_fnAfterVariantLoad:function(e){let t=e.getSource();let r=t.getFilterData();let a=r["_CUSTOM"];let o=this._byId("cboViaPago");o.setSelectedKeys(a.ViaPago)},confirmDialog:function(e){if(this.oInputOrigin){this.oInputOrigin.setValue(e.getParameters().selectedItem.getAttributes()[0].getText());if(this.oInputAsoc){this.oInputAsoc.setValue(e.getParameters().selectedItem.getTitle())}}},processBankDetail:function(e){var r=this;t.confirm(this.getI18nText("dialogBanksBody"),{title:this.getI18nText("dialogBanksTitle"),actions:[t.Action.OK,t.Action.CANCEL],onClose:e=>{if(e==="OK"){sap.ui.core.BusyIndicator.show(0);var a="/Im_Proccab_072Set";var o=this.getOwnerComponent().getModel();let e=y.getData();let i=e.dataDetalleFacturas;if(!i.length){sap.ui.core.BusyIndicator.hide();t.error("Debe seleccionar un registro para procesar");return false}let d={Bukrs:i[0].Bukrs,Lifnr:"",Belnr:"",Hbkid:"",Check:"",Im_TR072_Detalle_Set:[],Campfilt_072Set:[]};let c=r._byId("tableReporte");let u=c.getSelectedItems();let g=[];if(!u.length){sap.ui.core.BusyIndicator.hide();t.error("Debe seleccionar un registro para procesar");return false}for(let e=0;e<u.length;e++){let t=u[e].getBindingContext("TablaResultadosModel");let r=t.getObject();if(r.Total||r.Zlsch==="X"){continue}let a=i.filter(e=>e.Bukrs===r.Bukrs&&e.Hbkid===r.Hbkid&&e.Zlsch===r.Zlsch&&e.Waers===r.Waers);$.each(a,function(e,t){g.push(t)})}for(let e=0;e<g.length;e++){let t=g[e];if(t.Zlsch!=="X"&&!t.Total){t.Bldat=t.Bldat;t.Budat=t.Budat;t.Zfbdt=t.Zfbdt;t.Zvenc=t.Zvenc;t.Wrbtr=parseFloat(t.Wrbtr).toFixed(2);t.Dmbtr=parseFloat(t.Dmbtr).toFixed(2);delete t.Zbd1t;delete t.Total;delete t.__metadata;delete t.to_Acreedor;delete t.to_Pais;delete t.to_Sociedad;d.Im_TR072_Detalle_Set.push(t);var l={},s={},n={};if(t.Belnr){l.Campo="BELNR";l.Bukrs="";l.Belnr=t.Belnr;l.Sign="I";l.Option="EQ";l.Valor1=t.Belnr;d.Campfilt_072Set.push(l)}if(t.Bukrs){s.Campo="BUKRS";s.Bukrs=t.Bukrs;s.Belnr="";s.Sign="I";s.Option="EQ";s.Valor1=t.Bukrs;d.Campfilt_072Set.push(s)}if(t.Lifnr){n.Campo="LIFNR";n.Bukrs="";n.Belnr=t.Belnr;n.Sign="I";n.Option="EQ";n.Valor1=t.Lifnr;d.Campfilt_072Set.push(n)}}}o.create(a,d,{success:function(e){sap.ui.core.BusyIndicator.hide();t.success(r.getI18nText("dialogBanksSuccess"))},error:function(e){sap.ui.core.BusyIndicator.hide();console.log(e)}})}}})},_byId:function(e){var t=this.byId(e);if(!t){t=sap.ui.getCore().byId(e)}return t},getI18nText:function(e,t=[]){return t.length>0?this.getView().getModel("i18n").getResourceBundle().getText(e,t):this.getView().getModel("i18n").getResourceBundle().getText(e)},openFragmentFacturas:function(){let e=this.byId("tableReporte");let r=e.getSelectedItems();if(r.length>0){let e=sap.ui.xmlfragment("com.centria.ReclasificacionViasPagoAcreedores.view.fragments.Facturas",this);this.getView().addDependent(e);e.open()}else{t.information(this.getI18nText("txtWarningSelected"))}},openFragmentProveedores:function(){let e=sap.ui.xmlfragment("com.centria.ReclasificacionViasPagoAcreedores.view.fragments.Proveedores",this);this.getView().addDependent(e);e.open()},closeDialog:function(e){e.getSource().getParent().destroy();this._oDialog=null},onCloseDialog:function(e){e.getSource().destroy();this._oDialog=null},getServiceModel:function(){return this.getOwnerComponent().getModel()},readEntity:function(e,t=[]){return new Promise((r,a)=>{this.getServiceModel().read("/"+e,{filters:t,success:e=>{r(e)},error:e=>{a(e)}})})},createEntry:function(e,t={}){return new Promise((r,a)=>{this.getServiceModel().create("/"+e,t,{success:e=>{r(e)},error:e=>{a(e)}})})},deleteRegisters:function(e){let r=this;let a=this._byId("tblFacturas");let o=y.getData();let l=o.dataDetalleFacturas;let s=a.getSelectedItems();let n={};let i=[];function d(){for(let e=0;e<s.length;e++){let t=s[e].getBindingContext("TablaResultadosModel");let r=t.getObject();r.Hbkid="9999";r.Waers="";r.Zlsch="X";r.Sgtxt="Listado de excepciones"}for(let e=0;e<l.length;e++){let t=l[e];let r=t.Bukrs+t.Hbkid+t.Waers+t.Zlsch+t.Sgtxt;if(!n.hasOwnProperty(r)){n[r]={Bukrs:t.Bukrs,Hbkid:t.Hbkid,Waers:t.Waers,Zlsch:t.Zlsch,Sgtxt:t.Sgtxt,Nrreg:parseInt(t.Nrreg,0),Dmbtr:parseFloat(t.Dmbtr),Wrbtr:parseFloat(t.Wrbtr),Total:false}}else{n[r].Dmbtr+=parseFloat(t.Dmbtr);n[r].Wrbtr+=parseFloat(t.Wrbtr);n[r].Nrreg+=parseInt(t.Nrreg,0)}}let e=0,t=0;for(let a in n){if(n.hasOwnProperty(a)){e+=n[a].Dmbtr;t+=n[a].Wrbtr;n[a].Dmbtr=r.redondearMonto(n[a].Dmbtr);n[a].Wrbtr=r.redondearMonto(n[a].Wrbtr);i.push(n[a])}}D.setProperty("/MontoBancoPEN",e);D.setProperty("/MontoBancoUSD",t);r.ordenarBanco(i);o.dataDetalleBancos=i;y.setData(o);y.refresh();a.getBinding("items").filter([S]);f.show(r.getI18nText("deletedRegisters"))}if(s.length===0){f.show(this.getI18nText("noDeletedRegisters"))}else{t.confirm("¿Desea eliminar las facturas seleccionadas?",{title:"Eliminar Facturas",onClose:function(e){if(e==="OK"){d()}}})}},onCloseFragment:function(e){this._oFragment.close()},onAfterCloseFragment:function(e){this._oFragment.destroy()},onCloseFragmentEntidad:function(e){this._oFragmentEntidad.close()},onAfterCloseFragmentEntidad:function(e){this._oFragmentEntidad.destroy()},formatSAP:function(e){if(e){var t=e.split("T",1)[0];var r,a,o;o=t.split("-",3)[0];r=t.split("-",3)[1];a=t.split("-",3)[2];var l=o+"-"+r+"-"+a;return l}},formatterFechaSAP:function(e){if(e!==null&&e!==undefined){var t=e;var r=""+(t.getMonth()+1),a=""+t.getDate(),o=""+t.getFullYear();if(r.length<2)r="0"+r;if(a.length<2)a="0"+a;return[o,r,a].join("-")}else{return""}}})});